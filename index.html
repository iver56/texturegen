<!DOCTYPE html>
<link rel=stylesheet type=text/css href=res/master.css>
<script src=lib/interact.js></script>
<script src=lib/perlin.js></script>
<script src=lib/jscolor.js></script>
<script src=src/texturegen.js></script>
<script src=src/TextureGen.js></script>
<script src=src/NodeManager.js></script>
<script src=src/BaseNode.js></script>
<script src=src/ColorNode.js></script>
<script src=src/NumberNode.js></script>
<script src=src/CanvasNode.js></script>
<script src=src/FillNode.js></script>
<script src=src/PerlinNode.js></script>
<script src=src/AddNode.js></script>

<div class=ui-button-container>
  <a class="export-button ui-button">Export</a>
  <a class="import-button ui-button">Import</a>
  <a class="add-new-button ui-button">+</a>
</div>

<canvas class=connecting-lines>
</canvas>

<div id=editor>
</div>

<script>

var editor = document.getElementById('editor');

var nodeManager = new TextureGen.NodeManager(editor);

interact('.output').draggable({autoScroll: true});

interact('.input').dropzone({
  accept: '.output',
  ondrop: function (event) {
    var toId = event.target.parentElement.parentElement.dataset.id;
    var fromId = event.relatedTarget.parentElement.dataset.id;
    var inputName = event.target.dataset.name;
    nodeManager.connect(fromId, toId, inputName);
  }
});


interact('.node .title')
  .draggable({
    autoScroll: true,
    onmove: dragMoveListener
  });

  function dragMoveListener (event) {
    var target = event.target.parentElement;
    var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
    var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    target.style.webkitTransform =
    target.style.transform =
      'translate(' + x + 'px, ' + y + 'px)';
    target.setAttribute('data-x', x);
    target.setAttribute('data-y', y);
  }


document.querySelector('.add-new-button').addEventListener('click', function() {
  var nodeType = prompt('Node type?');
  nodeManager.createNode(TextureGen[nodeType + 'Node']);
});

document.querySelector('.export-button').addEventListener('click', function() {
  console.log(nodeManager.export());
  alert('copy paste it from browser console');
});

document.querySelector('.import-button').addEventListener('click', function() {
  var json = prompt('json?');
  nodeManager.import(json);
});


var connectingLineCanvas = document.querySelector('.connecting-lines');
var connectingLineCtx = connectingLineCanvas.getContext('2d');
var connectingLines = [];

function renderConnectingLines() {

  connectingLineCtx.clearRect(0, 0, connectingLineCanvas.width, connectingLineCanvas.height);
  connectingLineCtx.strokeStyle = '#555';
  for(var id in nodeManager.nodes) {
    var node = nodeManager.nodes[id];
    for(var key in node.inputs) {
      if(!node.inputs[key]) {
        continue;
      }

      var inputRect = node.domInputs[key].getBoundingClientRect();
      var outputRect = node.inputs[key].domOutput.getBoundingClientRect();
      var inputX = inputRect.left;
      var inputY = inputRect.top + inputRect.height / 2;
      var outputX = outputRect.right;
      var outputY = outputRect.top + outputRect.height / 2;
      connectingLineCtx.beginPath();
      connectingLineCtx.moveTo(inputX, inputY);
      connectingLineCtx.lineTo(outputX, outputY);
      connectingLineCtx.stroke();
    }
  }
}
function onResize() {
  connectingLineCanvas.width = window.innerWidth; 
  connectingLineCanvas.height = window.innerHeight; 
  renderConnectingLines();
}

window.addEventListener('resize', onResize);
onResize();

function renderConnectingLinesLoop() {
  requestAnimationFrame(renderConnectingLinesLoop);
  renderConnectingLines();
}
renderConnectingLinesLoop();

</script>
